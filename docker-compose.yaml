# services:
#   mt5:
#     build: .
#     image: gmag11/metatrader5_vnc
#     container_name: mt5
#     volumes:
#       - ./config:/config
#     ports:
#       - 3000:3000
#       - 8001:8001
#     env_file:
#       - .env
version: "3.9"

services:

  # MT5 Terminal for VNC access (existing)
  mt5-terminal:
    build: .
    container_name: mt5-terminal
    restart: always
    volumes:
      - ./Metatrader:/home/wineuser/.wine/drive_c/ProgramData/MetaQuotes/Terminal
    environment:
      - DISPLAY=:0
    ports:
      - "5901:5901"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mt5-terminal.rule=Host(`mt5.traintrading.trainflow.dev`)"
      - "traefik.http.routers.mt5-terminal.entrypoints=websecure"
      - "traefik.http.routers.mt5-terminal.tls.certresolver=letsencrypt"
    depends_on:
      - traefik

  # NoVNC for MT5 terminal access
  novnc:
    image: theasp/novnc:latest
    container_name: novnc
    restart: always
    environment:
      - VNC_HOST=mt5-terminal
      - VNC_PORT=5901
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.novnc.rule=Host(`mt5.traintrading.trainflow.dev`)"
      - "traefik.http.routers.novnc.entrypoints=websecure"
      - "traefik.http.routers.novnc.tls.certresolver=letsencrypt"

  # MT5 Trading Server API (new)
  mt5-server:
    build:
      context: .
      dockerfile: Dockerfile.server
    container_name: mt5-server
    restart: always
    env_file:
      - .env
    volumes:
      - ./logs:/var/log
      - ./data:/app/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mt5-api.rule=Host(`api.traintrading.trainflow.dev`)"
      - "traefik.http.routers.mt5-api.entrypoints=websecure"
      - "traefik.http.routers.mt5-api.tls.certresolver=letsencrypt"
      - "traefik.http.middlewares.mt5-api-cors.headers.accesscontrolalloworiginlist=trainflow.dev,www.trainflow.dev,traintrading.trainflow.dev"
      - "traefik.http.middlewares.mt5-api-cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,OPTIONS"
      - "traefik.http.middlewares.mt5-api-cors.headers.accesscontrolallowheaders=Authorization,Content-Type,X-API-Key"
      - "traefik.http.routers.mt5-api.middlewares=mt5-api-cors"
    depends_on:
      - traefik
      - mt5-terminal

  # PostgreSQL for MT5 server data (optional)
  postgres:
    image: postgres:15
    container_name: mt5-postgres
    restart: always
    environment:
      POSTGRES_DB: mt5_server
      POSTGRES_USER: mt5_user
      POSTGRES_PASSWORD: secure_password_change_me
    volumes:
      - postgres_data:/var/lib/postgresql/data
    labels:
      - "traefik.enable=false"  # Internal only

  # Redis for caching (optional)
  redis:
    image: redis:7-alpine
    container_name: mt5-redis
    restart: always
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    labels:
      - "traefik.enable=false"  # Internal only

  traefik:
    image: traefik:latest
    container_name: traefik
    restart: always
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=edubem80@gmail.com"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik/letsencrypt:/letsencrypt"

volumes:
  postgres_data:
  redis_data: